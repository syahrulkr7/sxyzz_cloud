<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudBox - Penyimpanan Online</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css untuk animasi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --pastel-blue: #a7d2f0;
            --pastel-green: #b5e8c3;
            --pastel-pink: #f8c8dc;
            --pastel-purple: #d9c5f4;
            --pastel-yellow: #f9e8a9;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
        }
        
        .border-outset {
            border-style: outset;
        }
        
        .file-card {
            transition: all 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .login-container {
            animation: fadeIn 0.8s ease-out;
        }
        
        .dashboard-container {
            animation: slideIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .file-icon {
            font-size: 2.5rem;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #e0e0e0;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        /* Kategori warna */
        .photo-category { background-color: var(--pastel-blue); }
        .video-category { background-color: var(--pastel-pink); }
        .music-category { background-color: var(--pastel-green); }
        .doc-category { background-color: var(--pastel-purple); }
        .other-category { background-color: var(--pastel-yellow); }
        
        /* Animasi untuk loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Aplikasi Container -->
    <div id="app" class="min-h-screen">
        <!-- Login/Register Section -->
        <div id="auth-section" class="min-h-screen flex items-center justify-center p-4 login-container">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border-outset border-4" style="border-color: var(--pastel-blue);">
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background-color: var(--pastel-blue);">
                            <i class="fas fa-cloud text-3xl text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800">CloudBox</h1>
                        <p class="text-gray-600 mt-2">Penyimpanan online untuk semua file Anda</p>
                    </div>
                    
                    <div id="login-form">
                        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Masuk ke Akun Anda</h2>
                        <div class="mb-6 p-4 rounded-lg bg-blue-50 border-l-4 border-blue-500">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                Sistem akan mendeteksi alamat IP Anda secara otomatis. Jika Anda pernah login sebelumnya, Anda akan langsung masuk.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <label for="username" class="block text-gray-700 mb-2">Nama Pengguna</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-user text-gray-400"></i>
                                </div>
                                <input type="text" id="username" class="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none transition-colors" placeholder="Masukkan nama pengguna">
                            </div>
                            <p id="username-error" class="text-red-500 text-sm mt-1 hidden"></p>
                        </div>
                        
                        <button id="login-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 rounded-lg hover:opacity-90 transition-opacity mb-4 flex items-center justify-center">
                            <span id="login-text">
                                <i class="fas fa-sign-in-alt mr-2"></i>Masuk atau Daftar
                            </span>
                            <span id="login-spinner" class="hidden">
                                <i class="fas fa-circle-notch spinner mr-2"></i>Memproses...
                            </span>
                        </button>
                        
                        <div class="text-center text-sm text-gray-600">
                            <p>Dengan masuk, Anda menyetujui <a href="#" class="text-blue-600 hover:underline">Ketentuan Layanan</a> kami.</p>
                        </div>
                    </div>
                    
                    <div id="ip-info" class="mt-6 p-4 rounded-lg" style="background-color: var(--pastel-green);">
                        <div class="flex items-center">
                            <i class="fas fa-network-wired mr-3 text-lg"></i>
                            <div>
                                <p class="font-medium">Alamat IP Anda: <span id="ip-address" class="font-bold">Mendeteksi...</span></p>
                                <p class="text-sm mt-1">IP ini akan digunakan untuk login otomatis di masa depan.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Section (Awalnya tersembunyi) -->
        <div id="dashboard-section" class="hidden min-h-screen dashboard-container">
            <!-- Header -->
            <header class="bg-white shadow-md border-outset border-b-4" style="border-color: var(--pastel-purple);">
                <div class="container mx-auto px-4 py-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center mb-4 md:mb-0">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3" style="background-color: var(--pastel-purple);">
                                <i class="fas fa-cloud text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">CloudBox</h1>
                                <p class="text-sm text-gray-600">Penyimpanan online yang aman</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="hidden md:block text-right">
                                <p class="font-medium text-gray-800" id="welcome-user">Selamat datang, Pengguna!</p>
                                <p class="text-sm text-gray-600">IP: <span id="user-ip"></span></p>
                            </div>
                            <div class="relative">
                                <button id="user-menu-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 flex items-center justify-center" style="border-color: var(--pastel-blue); background-color: var(--pastel-blue);">
                                    <i class="fas fa-user text-white"></i>
                                </button>
                                <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-10">
                                    <div class="px-4 py-2 border-b">
                                        <p class="font-medium text-gray-800" id="menu-username"></p>
                                        <p class="text-xs text-gray-600" id="menu-ip"></p>
                                    </div>
                                    <button id="logout-btn" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Main Content -->
            <main class="container mx-auto px-4 py-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-md border-outset border-2 photo-category">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(255,255,255,0.7);">
                                <i class="fas fa-camera text-xl" style="color: #3b82f6;"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold" id="stats-photo">0</h3>
                                <p class="text-gray-600">Foto</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-md border-outset border-2 video-category">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(255,255,255,0.7);">
                                <i class="fas fa-video text-xl" style="color: #ec4899;"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold" id="stats-video">0</h3>
                                <p class="text-gray-600">Video</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-md border-outset border-2 music-category">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(255,255,255,0.7);">
                                <i class="fas fa-music text-xl" style="color: #10b981;"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold" id="stats-music">0</h3>
                                <p class="text-gray-600">Musik</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-md border-outset border-2 doc-category">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(255,255,255,0.7);">
                                <i class="fas fa-file text-xl" style="color: #8b5cf6;"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold" id="stats-doc">0</h3>
                                <p class="text-gray-600">Dokumen</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Storage Usage -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-8 border-outset border-2" style="border-color: var(--pastel-yellow);">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-hdd mr-2"></i> Penggunaan Penyimpanan
                    </h2>
                    <div class="mb-2 flex justify-between">
                        <span class="text-gray-700" id="storage-text">0 GB dari 10 GB digunakan</span>
                        <span class="font-bold" id="storage-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill bg-gradient-to-r from-green-400 to-blue-500" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mt-2">
                        <span>0 GB</span>
                        <span id="storage-limit">10 GB</span>
                    </div>
                </div>
                
                <!-- Upload File Section -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-8 border-outset border-2" style="border-color: var(--pastel-green);">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Unggah File Baru
                    </h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 transition-colors" id="drop-area">
                        <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">Seret dan lepas file di sini atau klik untuk memilih</p>
                        <p class="text-sm text-gray-500 mb-4">Maksimum ukuran file: 100MB</p>
                        <input type="file" id="file-input" class="hidden" multiple>
                        <button id="browse-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:opacity-90 transition-opacity">
                            <i class="fas fa-folder-open mr-2"></i>Pilih File
                        </button>
                    </div>
                    <div id="file-list" class="mt-4 space-y-2"></div>
                </div>
                
                <!-- File Categories -->
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-folder-open mr-3"></i> File Saya
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Foto -->
                    <div class="file-card bg-white rounded-xl shadow-md overflow-hidden border-outset border-2 photo-category">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(167, 210, 240, 0.3);">
                                    <i class="fas fa-camera text-xl" style="color: #3b82f6;"></i>
                                </div>
                                <h3 class="text-xl font-bold">Foto</h3>
                            </div>
                            <p class="text-gray-600 mb-4" id="photo-info">0 file</p>
                            <button class="w-full bg-white text-blue-600 font-medium py-2 rounded-lg border-2 border-blue-500 hover:bg-blue-50 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Lihat Semua
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video -->
                    <div class="file-card bg-white rounded-xl shadow-md overflow-hidden border-outset border-2 video-category">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(248, 200, 220, 0.3);">
                                    <i class="fas fa-video text-xl" style="color: #ec4899;"></i>
                                </div>
                                <h3 class="text-xl font-bold">Video</h3>
                            </div>
                            <p class="text-gray-600 mb-4" id="video-info">0 file</p>
                            <button class="w-full bg-white text-pink-600 font-medium py-2 rounded-lg border-2 border-pink-500 hover:bg-pink-50 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Lihat Semua
                            </button>
                        </div>
                    </div>
                    
                    <!-- Musik -->
                    <div class="file-card bg-white rounded-xl shadow-md overflow-hidden border-outset border-2 music-category">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(181, 232, 195, 0.3);">
                                    <i class="fas fa-music text-xl" style="color: #10b981;"></i>
                                </div>
                                <h3 class="text-xl font-bold">Musik</h3>
                            </div>
                            <p class="text-gray-600 mb-4" id="music-info">0 file</p>
                            <button class="w-full bg-white text-green-600 font-medium py-2 rounded-lg border-2 border-green-500 hover:bg-green-50 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Lihat Semua
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dokumen -->
                    <div class="file-card bg-white rounded-xl shadow-md overflow-hidden border-outset border-2 doc-category">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background-color: rgba(217, 197, 244, 0.3);">
                                    <i class="fas fa-file text-xl" style="color: #8b5cf6;"></i>
                                </div>
                                <h3 class="text-xl font-bold">Dokumen</h3>
                            </div>
                            <p class="text-gray-600 mb-4" id="doc-info">0 file</p>
                            <button class="w-full bg-white text-purple-600 font-medium py-2 rounded-lg border-2 border-purple-500 hover:bg-purple-50 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Lihat Semua
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Files -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-history mr-3"></i> File Terbaru
                    </h2>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border-outset border-2" style="border-color: var(--pastel-blue);">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left">Nama File</th>
                                        <th class="py-3 px-4 text-left">Jenis</th>
                                        <th class="py-3 px-4 text-left">Ukuran</th>
                                        <th class="py-3 px-4 text-left">Tanggal</th>
                                        <th class="py-3 px-4 text-left">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-files">
                                    <tr>
                                        <td colspan="5" class="py-8 text-center text-gray-500">
                                            <i class="fas fa-folder-open text-3xl mb-2"></i>
                                            <p>Belum ada file. Unggah file pertama Anda!</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Footer -->
            <footer class="mt-12 py-6 text-center text-gray-600 border-t border-gray-200">
                <div class="container mx-auto px-4">
                    <p>© 2023 CloudBox. Semua hak dilindungi.</p>
                    <p class="text-sm mt-2">Dibuat dengan <i class="fas fa-heart text-red-500"></i> untuk penyimpanan online yang lebih baik</p>
                </div>
            </footer>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50">
            <div class="flex items-center">
                <i id="toast-icon" class="fas fa-info-circle mr-3"></i>
                <p id="toast-message"></p>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // KONFIGURASI APLIKASI
        // ============================
        const APP_NAME = 'CloudBox';
        const STORAGE_KEY = 'cloudbox_users';
        const CURRENT_USER_KEY = 'cloudbox_current_user';
        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
        
        // ============================
        // API untuk mendapatkan IP (dengan fallback)
        // ============================
        const IP_API_URLS = [
            'https://api.ipify.org?format=json',
            'https://api64.ipify.org?format=json',
            'https://ipinfo.io/json'
        ];
        
        // ============================
        // KELAS UTILITAS
        // ============================
        class Toast {
            static show(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastIcon = document.getElementById('toast-icon');
                const toastMessage = document.getElementById('toast-message');
                
                // Set ikon berdasarkan tipe
                let iconClass = 'fa-info-circle';
                let bgColor = 'bg-gray-800';
                
                switch(type) {
                    case 'success':
                        iconClass = 'fa-check-circle';
                        bgColor = 'bg-green-600';
                        break;
                    case 'error':
                        iconClass = 'fa-exclamation-circle';
                        bgColor = 'bg-red-600';
                        break;
                    case 'warning':
                        iconClass = 'fa-exclamation-triangle';
                        bgColor = 'bg-yellow-600';
                        break;
                }
                
                // Update toast
                toastIcon.className = `fas ${iconClass} mr-3`;
                toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50`;
                toastMessage.textContent = message;
                
                // Tampilkan toast
                setTimeout(() => {
                    toast.classList.remove('translate-y-full', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                }, 10);
                
                // Sembunyikan toast setelah 3 detik
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-full', 'opacity-0');
                }, 3000);
            }
        }
        
        class FileManager {
            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            static getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                    return 'fa-image';
                } else if (['mp4', 'avi', 'mov', 'wmv', 'flv'].includes(ext)) {
                    return 'fa-video';
                } else if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(ext)) {
                    return 'fa-music';
                } else if (['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx'].includes(ext)) {
                    return 'fa-file-alt';
                } else {
                    return 'fa-file';
                }
            }
            
            static getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                    return 'Foto';
                } else if (['mp4', 'avi', 'mov', 'wmv', 'flv'].includes(ext)) {
                    return 'Video';
                } else if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(ext)) {
                    return 'Musik';
                } else if (['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx'].includes(ext)) {
                    return 'Dokumen';
                } else {
                    return 'Lainnya';
                }
            }
        }
        
        // ============================
        // KELAS APLIKASI UTAMA
        // ============================
        class CloudBoxApp {
            constructor() {
                this.currentUser = null;
                this.userIP = null;
                this.users = this.loadUsers();
                this.isInitializing = true;
                
                // Inisialisasi app
                this.initializeApp();
            }
            
            // Muat data pengguna dari localStorage
            loadUsers() {
                try {
                    const usersJson = localStorage.getItem(STORAGE_KEY);
                    return usersJson ? JSON.parse(usersJson) : {};
                } catch (error) {
                    console.error('Error loading users:', error);
                    return {};
                }
            }
            
            // Simpan data pengguna ke localStorage
            saveUsers() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.users));
                } catch (error) {
                    console.error('Error saving users:', error);
                }
            }
            
            // Dapatkan alamat IP pengguna dengan multiple fallback
            async getUserIP() {
                // Coba beberapa API
                for (const apiUrl of IP_API_URLS) {
                    try {
                        const response = await fetch(apiUrl, { timeout: 5000 });
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        if (apiUrl.includes('ipinfo')) {
                            return data.ip;
                        } else {
                            return data.ip || data;
                        }
                    } catch (error) {
                        console.log(`API ${apiUrl} failed, trying next...`);
                        continue;
                    }
                }
                
                // Jika semua API gagal, gunakan IP fallback untuk demo
                console.log('All IP APIs failed, using fallback IP');
                return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
            }
            
            // Validasi username
            validateUsername(username) {
                if (!username || username.trim() === '') {
                    return { valid: false, message: 'Username tidak boleh kosong' };
                }
                
                if (username.length < 3) {
                    return { valid: false, message: 'Username minimal 3 karakter' };
                }
                
                if (username.length > 20) {
                    return { valid: false, message: 'Username maksimal 20 karakter' };
                }
                
                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    return { valid: false, message: 'Username hanya boleh berisi huruf, angka, dan underscore' };
                }
                
                return { valid: true, message: '' };
            }
            
            // Login atau daftar pengguna
            loginOrRegister(username, ip) {
                const validation = this.validateUsername(username);
                if (!validation.valid) {
                    Toast.show(validation.message, 'error');
                    return false;
                }
                
                // Bersihkan username
                username = username.trim();
                
                // Cek apakah pengguna sudah ada dengan IP yang sama
                const userKey = `${username}_${ip}`;
                
                if (this.users[userKey]) {
                    // Login pengguna yang sudah ada
                    this.currentUser = { username, ip, ...this.users[userKey] };
                    Toast.show(`Selamat datang kembali, ${username}!`, 'success');
                } else {
                    // Buat pengguna baru
                    const newUser = {
                        username,
                        ip,
                        createdAt: new Date().toISOString(),
                        files: [],
                        storageUsed: 0,
                        storageLimit: 10 * 1024 * 1024 * 1024 // 10GB
                    };
                    
                    this.users[userKey] = newUser;
                    this.currentUser = newUser;
                    this.saveUsers();
                    
                    Toast.show(`Akun baru berhasil dibuat untuk ${username}!`, 'success');
                }
                
                // Simpan pengguna saat ini
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(this.currentUser));
                
                return true;
            }
            
            // Logout pengguna
            logout() {
                this.currentUser = null;
                localStorage.removeItem(CURRENT_USER_KEY);
                Toast.show('Anda telah keluar', 'info');
                this.showLogin();
            }
            
            // Cek apakah ada pengguna yang sudah login
            checkAutoLogin() {
                try {
                    const savedUser = localStorage.getItem(CURRENT_USER_KEY);
                    
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        const userKey = `${user.username}_${user.ip}`;
                        
                        // Verifikasi bahwa pengguna masih ada di database
                        if (this.users[userKey]) {
                            // Update dengan data terbaru dari database
                            this.currentUser = { ...user, ...this.users[userKey] };
                            return true;
                        } else {
                            // Hapus data login jika user tidak ditemukan
                            localStorage.removeItem(CURRENT_USER_KEY);
                        }
                    }
                } catch (error) {
                    console.error('Error checking auto-login:', error);
                    localStorage.removeItem(CURRENT_USER_KEY);
                }
                
                return false;
            }
            
            // Tambahkan file ke pengguna
            addFile(file) {
                if (!this.currentUser) return false;
                
                const userKey = `${this.currentUser.username}_${this.currentUser.ip}`;
                
                // Cek ukuran file
                if (file.size > MAX_FILE_SIZE) {
                    Toast.show(`File ${file.name} terlalu besar (maksimal ${FileManager.formatFileSize(MAX_FILE_SIZE)})`, 'error');
                    return false;
                }
                
                // Cek apakah penyimpanan cukup
                if (this.currentUser.storageUsed + file.size > this.currentUser.storageLimit) {
                    Toast.show('Penyimpanan tidak cukup', 'error');
                    return false;
                }
                
                // Tambahkan file
                const fileData = {
                    id: Date.now().toString(),
                    name: file.name,
                    size: file.size,
                    type: FileManager.getFileType(file.name),
                    uploadedAt: new Date().toISOString(),
                };
                
                this.users[userKey].files.push(fileData);
                this.users[userKey].storageUsed += file.size;
                this.currentUser = this.users[userKey];
                
                // Simpan perubahan
                this.saveUsers();
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(this.currentUser));
                
                Toast.show(`File ${file.name} berhasil diunggah`, 'success');
                return true;
            }
            
            // Inisialisasi aplikasi
            async initializeApp() {
                try {
                    // Tampilkan status deteksi IP
                    document.getElementById('ip-address').textContent = 'Mendeteksi...';
                    
                    // Dapatkan IP pengguna
                    this.userIP = await this.getUserIP();
                    
                    // Update tampilan IP
                    const ipElement = document.getElementById('ip-address');
                    if (ipElement) {
                        ipElement.textContent = this.userIP;
                        ipElement.classList.remove('text-gray-500');
                        ipElement.classList.add('text-green-600');
                    }
                    
                    // Cek auto-login
                    const isAutoLoggedIn = this.checkAutoLogin();
                    
                    if (isAutoLoggedIn) {
                        // Beri sedikit delay untuk animasi
                        setTimeout(() => {
                            this.showDashboard();
                        }, 500);
                    } else {
                        this.showLogin();
                    }
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Tampilkan pesan selamat datang
                    setTimeout(() => {
                        Toast.show(`Selamat datang di ${APP_NAME}!`, 'info');
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    Toast.show('Terjadi kesalahan saat menginisialisasi aplikasi', 'error');
                    
                    // Fallback ke mode login
                    this.userIP = 'Tidak terdeteksi';
                    document.getElementById('ip-address').textContent = this.userIP;
                    this.showLogin();
                } finally {
                    this.isInitializing = false;
                }
            }
            
            // Tampilkan halaman login
            showLogin() {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('dashboard-section').classList.add('hidden');
                
                // Reset form
                document.getElementById('username').value = '';
                document.getElementById('username-error').classList.add('hidden');
                
                // Tampilkan IP jika sudah didapatkan
                if (this.userIP) {
                    document.getElementById('ip-address').textContent = this.userIP;
                }
            }
            
            // Tampilkan dashboard
            showDashboard() {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                
                // Update info pengguna
                if (this.currentUser) {
                    document.getElementById('welcome-user').textContent = `Selamat datang, ${this.currentUser.username}!`;
                    document.getElementById('user-ip').textContent = this.currentUser.ip;
                    document.getElementById('menu-username').textContent = this.currentUser.username;
                    document.getElementById('menu-ip').textContent = `IP: ${this.currentUser.ip}`;
                    
                    // Update penggunaan penyimpanan
                    this.updateStorageInfo();
                    
                    // Update statistik file
                    this.updateFileStats();
                    
                    // Tampilkan file terbaru
                    this.displayRecentFiles();
                }
            }
            
            // Update informasi penyimpanan
            updateStorageInfo() {
                if (!this.currentUser) return;
                
                const usedGB = (this.currentUser.storageUsed / (1024 * 1024 * 1024)).toFixed(1);
                const totalGB = (this.currentUser.storageLimit / (1024 * 1024 * 1024)).toFixed(0);
                const usagePercent = ((this.currentUser.storageUsed / this.currentUser.storageLimit) * 100).toFixed(1);
                
                document.getElementById('storage-text').textContent = `${usedGB} GB dari ${totalGB} GB digunakan`;
                document.getElementById('storage-percent').textContent = `${usagePercent}%`;
                document.getElementById('storage-limit').textContent = `${totalGB} GB`;
                document.getElementById('progress-fill').style.width = `${usagePercent}%`;
            }
            
            // Update statistik file
            updateFileStats() {
                const stats = this.calculateFileStats();
                
                document.getElementById('stats-photo').textContent = stats.photo;
                document.getElementById('stats-video').textContent = stats.video;
                document.getElementById('stats-music').textContent = stats.music;
                document.getElementById('stats-doc').textContent = stats.doc;
                
                // Update info kategori
                document.getElementById('photo-info').textContent = `${stats.photo} file • Terakhir: ${stats.lastPhoto || '-'}`;
                document.getElementById('video-info').textContent = `${stats.video} file • Terakhir: ${stats.lastVideo || '-'}`;
                document.getElementById('music-info').textContent = `${stats.music} file • Terakhir: ${stats.lastMusic || '-'}`;
                document.getElementById('doc-info').textContent = `${stats.doc} file • Terakhir: ${stats.lastDoc || '-'}`;
            }
            
            // Hitung statistik file
            calculateFileStats() {
                const stats = { 
                    photo: 0, 
                    video: 0, 
                    music: 0, 
                    doc: 0, 
                    other: 0,
                    lastPhoto: null,
                    lastVideo: null,
                    lastMusic: null,
                    lastDoc: null
                };
                
                if (this.currentUser && this.currentUser.files) {
                    this.currentUser.files.forEach(file => {
                        if (file.type === 'Foto') {
                            stats.photo++;
                            if (!stats.lastPhoto || file.uploadedAt > stats.lastPhoto) {
                                stats.lastPhoto = new Date(file.uploadedAt).toLocaleDateString('id-ID');
                            }
                        }
                        else if (file.type === 'Video') {
                            stats.video++;
                            if (!stats.lastVideo || file.uploadedAt > stats.lastVideo) {
                                stats.lastVideo = new Date(file.uploadedAt).toLocaleDateString('id-ID');
                            }
                        }
                        else if (file.type === 'Musik') {
                            stats.music++;
                            if (!stats.lastMusic || file.uploadedAt > stats.lastMusic) {
                                stats.lastMusic = new Date(file.uploadedAt).toLocaleDateString('id-ID');
                            }
                        }
                        else if (file.type === 'Dokumen') {
                            stats.doc++;
                            if (!stats.lastDoc || file.uploadedAt > stats.lastDoc) {
                                stats.lastDoc = new Date(file.uploadedAt).toLocaleDateString('id-ID');
                            }
                        }
                        else {
                            stats.other++;
                        }
                    });
                }
                
                return stats;
            }
            
            // Tampilkan file terbaru
            displayRecentFiles() {
                const recentFilesContainer = document.getElementById('recent-files');
                
                if (!this.currentUser || !this.currentUser.files || this.currentUser.files.length === 0) {
                    recentFilesContainer.innerHTML = `
                        <tr>
                            <td colspan="5" class="py-8 text-center text-gray-500">
                                <i class="fas fa-folder-open text-3xl mb-2"></i>
                                <p>Belum ada file. Unggah file pertama Anda!</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Urutkan file berdasarkan tanggal upload (terbaru pertama)
                const sortedFiles = [...this.currentUser.files].sort((a, b) => 
                    new Date(b.uploadedAt) - new Date(a.uploadedAt)
                ).slice(0, 5); // Ambil 5 file terbaru
                
                let html = '';
                sortedFiles.forEach(file => {
                    const icon = FileManager.getFileIcon(file.name);
                    const size = FileManager.formatFileSize(file.size);
                    const date = new Date(file.uploadedAt).toLocaleDateString('id-ID');
                    
                    html += `
                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4">
                                <div class="flex items-center">
                                    <i class="fas ${icon} mr-3 text-blue-500"></i>
                                    <span class="font-medium truncate max-w-xs">${file.name}</span>
                                </div>
                            </td>
                            <td class="py-3 px-4">${file.type}</td>
                            <td class="py-3 px-4">${size}</td>
                            <td class="py-3 px-4">${date}</td>
                            <td class="py-3 px-4">
                                <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="cloudBoxApp.downloadFile('${file.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800" onclick="cloudBoxApp.deleteFile('${file.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                recentFilesContainer.innerHTML = html;
            }
            
            // Download file (simulasi)
            downloadFile(fileId) {
                const file = this.currentUser.files.find(f => f.id === fileId);
                if (file) {
                    Toast.show(`Mengunduh ${file.name}...`, 'info');
                    // Dalam implementasi nyata, ini akan mengunduh file dari server
                }
            }
            
            // Delete file
            deleteFile(fileId) {
                if (!confirm('Apakah Anda yakin ingin menghapus file ini?')) return;
                
                const userKey = `${this.currentUser.username}_${this.currentUser.ip}`;
                const fileIndex = this.users[userKey].files.findIndex(f => f.id === fileId);
                
                if (fileIndex !== -1) {
                    const file = this.users[userKey].files[fileIndex];
                    this.users[userKey].storageUsed -= file.size;
                    this.users[userKey].files.splice(fileIndex, 1);
                    this.currentUser = this.users[userKey];
                    
                    this.saveUsers();
                    localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(this.currentUser));
                    
                    Toast.show(`File berhasil dihapus`, 'success');
                    
                    // Update tampilan
                    this.updateStorageInfo();
                    this.updateFileStats();
                    this.displayRecentFiles();
                }
            }
            
            // Setup event listeners
            setupEventListeners() {
                // Tombol login/daftar
                document.getElementById('login-btn').addEventListener('click', () => {
                    this.handleLogin();
                });
                
                // Enter pada input username
                document.getElementById('username').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleLogin();
                    }
                });
                
                // Tombol logout
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.logout();
                });
                
                // Toggle user menu
                document.getElementById('user-menu-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('user-menu');
                    menu.classList.toggle('hidden');
                });
                
                // Tutup user menu saat klik di luar
                document.addEventListener('click', () => {
                    document.getElementById('user-menu').classList.add('hidden');
                });
                
                // Upload file
                const fileInput = document.getElementById('file-input');
                const browseBtn = document.getElementById('browse-btn');
                const dropArea = document.getElementById('drop-area');
                
                browseBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
                
                // Drag and drop
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('border-blue-500', 'bg-blue-50');
                });
                
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('border-blue-500', 'bg-blue-50');
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('border-blue-500', 'bg-blue-50');
                    
                    if (e.dataTransfer.files.length) {
                        this.handleFiles(e.dataTransfer.files);
                    }
                });
            }
            
            // Handle login
            handleLogin() {
                const username = document.getElementById('username').value.trim();
                const loginBtn = document.getElementById('login-btn');
                const loginText = document.getElementById('login-text');
                const loginSpinner = document.getElementById('login-spinner');
                
                // Tampilkan loading
                loginText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');
                loginBtn.disabled = true;
                
                // Simulasi proses login
                setTimeout(() => {
                    if (this.loginOrRegister(username, this.userIP)) {
                        this.showDashboard();
                    }
                    
                    // Sembunyikan loading
                    loginText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                    loginBtn.disabled = false;
                }, 800);
            }
            
            // Handle file upload
            handleFiles(files) {
                if (!this.currentUser) {
                    Toast.show('Silakan login terlebih dahulu', 'error');
                    return;
                }
                
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                
                // Tampilkan file yang dipilih
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                    fileItem.id = `file-${i}`;
                    
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas ${FileManager.getFileIcon(file.name)} mr-3 text-blue-500"></i>
                            <div>
                                <p class="font-medium truncate max-w-xs">${file.name}</p>
                                <p class="text-sm text-gray-500">${FileManager.formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <div class="upload-status">
                            <div class="w-5 h-5 border-2 border-gray-300 border-t-blue-500 rounded-full spinner"></div>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                }
                
                // Simulasi upload (dalam implementasi nyata, ini akan mengunggah ke server)
                setTimeout(() => {
                    // Reset file list
                    fileList.innerHTML = '<p class="text-green-600 font-medium"><i class="fas fa-check-circle mr-2"></i>Semua file berhasil diunggah!</p>';
                    
                    // Tambahkan file ke sistem
                    let successCount = 0;
                    for (let i = 0; i < files.length; i++) {
                        if (this.addFile(files[i])) {
                            successCount++;
                        }
                    }
                    
                    if (successCount > 0) {
                        // Update tampilan
                        this.updateStorageInfo();
                        this.updateFileStats();
                        this.displayRecentFiles();
                    }
                    
                    // Reset input file
                    document.getElementById('file-input').value = '';
                    
                    // Hapus pesan sukses setelah 3 detik
                    setTimeout(() => {
                        fileList.innerHTML = '';
                    }, 3000);
                }, 1500);
            }
        }
        
        // ============================
        // INISIALISASI APLIKASI
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi aplikasi
            window.cloudBoxApp = new CloudBoxApp();
            
            // Tambahkan animasi pada elemen saat scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                    }
                });
            }, observerOptions);
            
            // Amati semua file card
            setTimeout(() => {
                document.querySelectorAll('.file-card').forEach(card => {
                    observer.observe(card);
                });
            }, 500);
        });
        
        // Tambahkan timeout untuk fetch
        fetch = (function(originalFetch) {
            return function(url, options) {
                if (!options) options = {};
                if (!options.timeout) options.timeout = 5000;
                
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timeout')), options.timeout);
                });
                
                return Promise.race([originalFetch(url, options), timeoutPromise]);
            };
        })(fetch);
    </script>
</body>
</html>
